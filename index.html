<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRONOS // MASTER_SYNC</title>
    <style>
        :root { --neon: #00f3ff; --glass: rgba(0, 0, 0, 0.8); --pink: #ff0055; --border: rgba(0, 243, 255, 0.3); }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        
        /* LAYER 1: THE VOID */
        body { 
            background: #000 !important; 
            overflow: hidden; height: 100vh; width: 100vw; 
            font-family: 'Courier New', monospace; 
        }

        /* LAYER 2: THE MEDIA (SANDWICHED) */
        #media-deck {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; display: flex; justify-content: center; align-items: center;
            pointer-events: none;
        }
        video#bg-video, img#bg-image {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            display: none; opacity: 1;
        }

        /* LAYER 3: THE PARTICLES (TOPMOST VISUAL) */
        canvas#mainCanvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; background: transparent !important;
        }

        /* HUD: RIGID GRID LOCK */
        #hud { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px; z-index: 100;
            background: var(--glass); padding: 15px; border-radius: 12px; 
            border: 1px solid var(--border);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }

        #status { 
            font-size: 10px; color: var(--neon); margin-bottom: 10px; 
            letter-spacing: 2px; text-transform: uppercase; text-align: center;
        }

        .master-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(2, 50px);
            gap: 8px; 
        }

        .btn { 
            background: rgba(10, 10, 10, 0.9); border: 1px solid var(--border); 
            color: var(--neon); border-radius: 6px; font-size: 9px; font-weight: 900; 
            cursor: pointer; text-transform: uppercase; 
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn.active { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        .btn-capture { color: var(--pink); border-color: var(--pink); }
        
        input[type="file"] { display: none !important; } /* Hard hide to prevent UI shift */
    </style>
</head>
<body>

    <div id="media-deck">
        <video id="bg-video" playsinline loop crossorigin="anonymous"></video>
        <img id="bg-image" alt="User Memory">
    </div>

    <canvas id="mainCanvas"></canvas>

    <div id="hud">
        <div id="status">// KRONOS: MASTER_CORE_ACTIVE</div>
        <div class="master-grid">
            <label for="mem-up" class="btn">LOAD MEMORY</label>
            <input type="file" id="mem-up" accept="video/*,image/*">
            
            <label for="aud-up" class="btn">SONIC CORE</label>
            <input type="file" id="aud-up" accept="audio/*">
            
            <button id="vortBtn" class="btn">VORTEX: OFF</button>

            <button id="micBtn" class="btn">MIC SYNC</button>
            <button id="voidBtn" class="btn">VOID REVERT</button>
            <button id="recordBtn" class="btn btn-capture">CAPTURE</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        let audioCtx, analyser, dataArray, prioritySource = null;
        let bass = 0, avg = 0;
        let isVortex = false;

        const vid = document.getElementById('bg-video');
        const img = document.getElementById('bg-image');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 12;

        // MASTER TRANSPARENCY SETTINGS
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('mainCanvas'), 
            antialias: true, 
            alpha: true,
            premultipliedAlpha: false 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0); 

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 2.8, 0.4, 0.1);
        composer.addPass(bloom);

        const pCount = 2000;
        const hPoints = Array.from({ length: pCount }, () => [(Math.random()-0.5)*12, (Math.random()-0.5)*12, (Math.random()-0.5)*5]);
        const geo = new THREE.BufferGeometry();
        const mat = new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
        const swarm = new THREE.Points(geo, mat);
        scene.add(swarm);

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        function setReactiveSource(source, label) {
            if (prioritySource) prioritySource.disconnect();
            source.connect(analyser);
            source.connect(audioCtx.destination);
            prioritySource = source;
            document.getElementById('status').innerText = `// SYNC: ${label}`;
        }

        // LOAD MEMORY (VIDEO/IMAGE)
        document.getElementById('mem-up').onchange = async (e) => {
            await initAudio();
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            
            vid.style.display = 'none'; img.style.display = 'none';

            if (file.type.startsWith('video')) {
                vid.style.display = 'block'; vid.src = url; vid.play();
                const source = audioCtx.createMediaElementSource(vid);
                if (!prioritySource) setReactiveSource(source, "VIDEO");
            } else {
                img.style.display = 'block'; img.src = url;
                document.getElementById('status').innerText = "// SYNC: IMAGE_LOADED";
            }
        };

        // SONIC CORE (AUDIO FILE)
        document.getElementById('aud-up').onchange = async (e) => {
            await initAudio();
            const audio = new Audio(URL.createObjectURL(e.target.files[0]));
            audio.play();
            setReactiveSource(audioCtx.createMediaElementSource(audio), "FILE_CORE");
        };

        // MIC SYNC
        document.getElementById('micBtn').onclick = async () => {
            await initAudio();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setReactiveSource(audioCtx.createMediaStreamSource(stream), "MIC_LIVE");
            document.getElementById('micBtn').classList.add('active');
        };

        // VOID REVERT
        document.getElementById('voidBtn').onclick = () => {
            vid.style.display = 'none'; img.style.display = 'none';
            document.getElementById('status').innerText = "// MODE: VOID_REVERT";
        };

        // VORTEX TOGGLE
        document.getElementById('vortBtn').onclick = (e) => {
            isVortex = !isVortex;
            e.target.classList.toggle('active');
            e.target.innerText = isVortex ? "VORTEX: ON" : "VORTEX: OFF";
        };

        function animate() {
            requestAnimationFrame(animate);
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                let b = dataArray[4]/255;
                bass += (b - bass) * 0.2;
                bloom.strength = 1.0 + bass * 4;
            }

            const posA = new Float32Array(pCount * 3);
            const colA = new Float32Array(pCount * 3);

            hPoints.forEach((p, i) => {
                let x = p[0], y = p[1], z = p[2];
                if (isVortex) {
                    let d = Math.sqrt(x*x + y*y);
                    let a = (bass * 6) * (1.8 / (d + 0.5));
                    let nx = x * Math.cos(a) - y * Math.sin(a);
                    y = x * Math.sin(a) + y * Math.cos(a);
                    x = nx;
                }
                posA[i*3] = x; posA[i*3+1] = y; posA[i*3+2] = z;
                colA[i*3] = 0; colA[i*3+1] = 0.7 + bass; colA[i*3+2] = 1;
            });

            geo.setAttribute('position', new THREE.BufferAttribute(posA, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(colA, 3));
            composer.render();
        }
        animate();
    </script>
</body>
</html>
