<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPERION // INVERSE_ZENITH</title>
    <style>
        :root { --neon: #00f3ff; --glass: rgba(0, 0, 0, 0.5); --pink: #ff0055; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        
        body {
            background: #000;
            overflow: hidden; height: 100vh; width: 100vw;
            font-family: 'Courier New', monospace;
        }

        /* LAYER 1: PARTICLES (BOTTOM) */
        canvas#mainCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; /* Background Ambience */
            pointer-events: auto; /* Allow interaction with background */
        }

        /* LAYER 2: SHADED OVERLAY (MIDDLE) */
        #shade-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.65); /* Very transparent black shade */
            z-index: 5;
            pointer-events: none;
        }

        /* LAYER 3: MEDIA (TOP) */
        #media-deck {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; /* Top Priority */
            display: flex; justify-content: center; align-items: center;
            pointer-events: none;
        }
        video#bg-video, img#bg-image {
            max-width: 90%; max-height: 80%; /* Contained, not fullscreen stretch */
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.15); /* Soft glow edge */
            display: none; opacity: 1;
            border-radius: 8px;
        }

        /* UI CONTROLS */
        #ui {
            position: absolute; top: 25px; left: 25px; z-index: 100;
            color: var(--neon); font-size: 10px; letter-spacing: 2px;
            pointer-events: none; opacity: 0.9;
        }

        #controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 500px; z-index: 100;
            background: var(--glass); padding: 15px; border-radius: 12px;
            border: 1px solid rgba(0, 243, 255, 0.3);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }

        .btn, .color-container {
            background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(0, 243, 255, 0.3);
            color: var(--neon); padding: 12px; border-radius: 6px;
            cursor: pointer; text-transform: uppercase; font-size: 9px; font-weight: 800;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        input { display: none; }
        .color-preview { width: 12px; height: 12px; border-radius: 50%; background: var(--neon); border: 1px solid #fff; }
    </style>
</head>
<body>

    <canvas id="mainCanvas"></canvas>

    <div id="shade-overlay"></div>

    <div id="media-deck">
        <video id="bg-video" playsinline loop crossorigin="anonymous" muted></video>
        <img id="bg-image" alt="Visual Memory">
    </div>

    <div id="ui">
        // HYPERION GRAVITAS v.INVERSE<br>
        // VIDEO_LAYER: <span style="color:#ff0055">TOP_PRIORITY</span><br>
        // AUDIO_MODE: <span id="audio-status">MUTED_DEFAULT</span>
    </div>

    <div id="controls">
        <label for="visual-upload" class="btn">LOAD VIDEO</label>
        <input type="file" id="visual-upload" accept="video/*,image/*">

        <label for="audio-upload" class="btn">LOAD AUDIO</label>
        <input type="file" id="audio-upload" accept="audio/*">

        <label for="color-picker" class="color-container">
            TINT <div id="preview" class="color-preview"></div>
        </label>
        <input type="color" id="color-picker" value="#00f3ff">

        <div id="mic-btn" class="btn">MIC SYNC</div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        let audioCtx, analyser, dataArray;
        let bass = 0;
        let userHue = 185;

        // --- MEDIA LOGIC ---
        const vid = document.getElementById('bg-video');
        const img = document.getElementById('bg-image');

        document.getElementById('visual-upload').onchange = (e) => {
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            
            if (file.type.startsWith('video')) {
                img.style.display = 'none'; vid.style.display = 'block';
                vid.src = url; 
                vid.muted = true; // FORCE MUTE
                vid.play();
                document.getElementById('audio-status').innerText = "VIDEO_MUTED";
            } else {
                vid.style.display = 'none'; img.style.display = 'block';
                img.src = url;
            }
        };

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 14;

        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('mainCanvas'), 
            antialias: true, alpha: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        // Higher bloom since it's behind a shaded layer
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 2.5, 0.6, 0.1);
        composer.addPass(bloom);

        // --- PARTICLES ---
        const pCount = 1500;
        const positions = new Float32Array(pCount * 3);
        const colors = new Float32Array(pCount * 3);
        const originalPos = [];

        for(let i=0; i<pCount; i++) {
            let x = (Math.random() - 0.5) * 15;
            let y = (Math.random() - 0.5) * 15;
            let z = (Math.random() - 0.5) * 10;
            positions[i*3] = x; positions[i*3+1] = y; positions[i*3+2] = z;
            originalPos.push({x, y, z});
        }

        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        
        const mat = new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
        const swarm = new THREE.Points(geo, mat);
        scene.add(swarm);

        // --- AUDIO ---
        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        document.getElementById('audio-upload').onchange = async (e) => {
            await initAudio();
            const audio = new Audio(URL.createObjectURL(e.target.files[0]));
            audio.play();
            const src = audioCtx.createMediaElementSource(audio);
            src.connect(analyser); src.connect(audioCtx.destination);
            document.getElementById('audio-status').innerText = "AUDIO_ACTIVE";
        };

        document.getElementById('mic-btn').onclick = async () => {
            await initAudio();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const src = audioCtx.createMediaStreamSource(stream);
            src.connect(analyser);
            document.getElementById('audio-status').innerText = "MIC_LIVE";
        };

        // --- COLOR ---
        document.getElementById('color-picker').addEventListener('input', (e) => {
            document.getElementById('preview').style.background = e.target.value;
            userHue = parseInt(e.target.value.slice(1), 16); 
            // Simplified hex to hue calc for demo speed, relying on visual feedback
        });

        // --- ANIMATION ---
        let rotY = 0;
        function animate() {
            requestAnimationFrame(animate);
            
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                bass = dataArray[4] / 255;
                bloom.strength = 1.5 + bass * 4.0; // Strong bloom to punch through shade
            }

            const p = geo.attributes.position.array;
            const c = geo.attributes.color.array;

            swarm.rotation.y += 0.002 + (bass * 0.05);

            for(let i=0; i<pCount; i++) {
                // Breathing effect
                let pulse = 1 + (Math.sin(performance.now() * 0.001 + i) * 0.05) + (bass * 0.4);
                
                p[i*3] = originalPos[i].x * pulse;
                p[i*3+1] = originalPos[i].y * pulse;
                p[i*3+2] = originalPos[i].z * pulse;

                // Color tint
                c[i*3] = 0.1 + bass; // Red/Blue shift
                c[i*3+1] = 0.8;
                c[i*3+2] = 1.0;
            }

            geo.attributes.position.needsUpdate = true;
            geo.attributes.color.needsUpdate = true;

            composer.render();
        }
        animate();
    </script>
</body>
</html>
