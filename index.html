<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRONOS // IMMERSIVE</title>
    <style>
        :root { --neon-cyan: #00f3ff; --glass-bg: rgba(0, 0, 0, 0.6); --olympus-gold: #ffd700; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #000; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Courier New', monospace; }
        
        /* Full Screen Layers */
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        
        video#bg-video { 
            position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; 
            width: auto; height: auto; transform: translate(-50%, -50%); 
            object-fit: cover; z-index: 0; 
        }

        #video-dimmer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.25); /* Lightened for visibility */
            pointer-events: none; z-index: 1; 
        }

        canvas#mainCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: grab; }

        /* HUD Overlay */
        #hud { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 600px; z-index: 10; display: flex; flex-direction: column; gap: 10px;
            background: var(--glass-bg); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }

        .controls-row { display: flex; gap: 8px; }
        .btn { 
            flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; padding: 12px 5px; border-radius: 10px; font-size: 10px; font-weight: 900; 
            cursor: pointer; text-transform: uppercase; text-align: center;
        }
        .btn.active { border-color: var(--neon-cyan); color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
        
        input[type="file"], input[type="color"] { display: none; }
        #status-text { font-size: 9px; color: var(--neon-cyan); text-align: center; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="container">
        <video id="bg-video" playsinline loop muted></video>
        <div id="video-dimmer"></div>
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="hud">
        <div id="status-text">KRONOS // SYNC READY</div>
        <div class="controls-row">
            <label for="vid-up" class="btn">LOAD VIDEO</label>
            <input type="file" id="vid-up" accept="video/*">
            
            <label for="aud-up" class="btn">AUDIO CORE</label>
            <input type="file" id="aud-up" accept="audio/*">
            
            <button id="vortBtn" class="btn">VORTEX: OFF</button>
        </div>
        <div class="controls-row">
            <label for="color-picker" class="btn" id="tint-label">TINT PARTICLES</label>
            <input type="color" id="color-picker" value="#00f3ff">
            
            <button id="micBtn" class="btn">MIC</button>
            <button id="recordBtn" class="btn" style="color: #ff0055;">REC</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';

        let audioCtx, analyser, dataArray, prioritySource = null;
        let bass = 0, avg = 0, treble = 0, isVortex = false;
        let particleColor = new THREE.Color(0x00f3ff);

        const video = document.getElementById('bg-video');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 10;

        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('mainCanvas'), antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.8, 0.4, 0.1);
        composer.addPass(bloom);

        // Particle System
        const pCount = 2500;
        const hPoints = Array.from({ length: pCount }, () => ({
            pos: new THREE.Vector3((Math.random()-0.5)*15, (Math.random()-0.5)*15, (Math.random()-0.5)*15),
            speed: Math.random() * 0.02 + 0.005
        }));
        const geo = new THREE.BufferGeometry();
        const mat = new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
        const swarm = new THREE.Points(geo, mat);
        scene.add(swarm);

        // Audio Engine
        function setupAudio(source, label) {
            if (!audioCtx) audioCtx = new AudioContext();
            if (!analyser) {
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
            if (prioritySource) prioritySource.disconnect();
            source.connect(analyser);
            prioritySource = source;
            document.getElementById('status-text').innerText = `KRONOS // ACTIVE: ${label}`;
        }

        document.getElementById('vid-up').onchange = (e) => {
            video.src = URL.createObjectURL(e.target.files[0]);
            video.play();
            const source = (audioCtx || new AudioContext()).createMediaElementSource(video);
            source.connect((audioCtx || new AudioContext()).destination);
            setupAudio(source, "VIDEO_LINK");
        };

        document.getElementById('aud-up').onchange = (e) => {
            const audio = new Audio(URL.createObjectURL(e.target.files[0]));
            audio.play();
            const source = (audioCtx || new AudioContext()).createMediaElementSource(audio);
            source.connect((audioCtx || new AudioContext()).destination);
            setupAudio(source, "SONIC_CORE");
        };

        document.getElementById('color-picker').oninput = (e) => {
            particleColor.set(e.target.value);
            document.getElementById('tint-label').style.color = e.target.value;
        };

        document.getElementById('vortBtn').onclick = (e) => {
            isVortex = !isVortex;
            e.target.classList.toggle('active');
            e.target.innerText = isVortex ? "VORTEX: ON" : "VORTEX: OFF";
        };

        function animate() {
            requestAnimationFrame(animate);
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                bass = dataArray[2]/255; avg = dataArray[128]/255; treble = dataArray[200]/255;
                bloom.strength = 1.0 + (bass * 2.5);
            }

            const positions = new Float32Array(pCount * 3);
            const colors = new Float32Array(pCount * 3);

            hPoints.forEach((p, i) => {
                let time = performance.now() * 0.001;
                let angle = time * p.speed * 10;
                
                // Rotation
                let x = p.pos.x * Math.cos(angle) - p.pos.z * Math.sin(angle);
                let z = p.pos.x * Math.sin(angle) + p.pos.z * Math.cos(angle);
                let y = p.pos.y;

                if (isVortex) {
                    let d = Math.sqrt(x*x + z*z);
                    let force = (bass * 3.0) - (treble * 1.5);
                    let vAngle = force * (1.0 / (d + 0.5));
                    let vx = x * Math.cos(vAngle) - z * Math.sin(vAngle);
                    z = x * Math.sin(vAngle) + z * Math.cos(vAngle);
                    x = vx;
                }

                positions[i*3] = x; positions[i*3+1] = y; positions[i*3+2] = z;
                
                // Set color from picker + bass intensity
                colors[i*3] = particleColor.r + (bass * 0.2);
                colors[i*3+1] = particleColor.g + (avg * 0.1);
                colors[i*3+2] = particleColor.b + (treble * 0.3);
            });

            geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            swarm.rotation.y += 0.001;
            composer.render();
        }

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        };

        animate();
    </script>
</body>
</html>
