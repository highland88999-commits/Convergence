<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPERION // INVERSE_ZENITH</title>
    <style>
        :root { --neon: #00f3ff; --glass: rgba(0, 0, 0, 0.55); --pink: #ff0055; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        
        body { background: #000; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Courier New', monospace; }

        canvas#mainCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        #ui {
            position: absolute; top: 25px; left: 25px; z-index: 100;
            color: var(--neon); font-size: 10px; letter-spacing: 2px;
            pointer-events: none; opacity: 0.92; text-shadow: 0 0 10px var(--neon);
        }

        #controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 520px; z-index: 100;
            background: var(--glass); padding: 16px; border-radius: 14px;
            border: 1px solid rgba(0, 243, 255, 0.35); backdrop-filter: blur(15px);
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        .btn, .color-container {
            background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(0, 243, 255, 0.4);
            color: var(--neon); padding: 13px; border-radius: 8px;
            cursor: pointer; text-transform: uppercase; font-size: 9px; font-weight: 800;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        input { display: none; }
        .color-preview { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #fff; }
        .glitch { color: var(--pink); animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <canvas id="mainCanvas"></canvas>

    <div id="ui">
        // HYPERION // INVERSE_ZENITH<br>
        // STATUS: <span id="sync-status" class="glitch">AWAITING CORE</span><br>
        // ARCH: VISUAL_BEHIND_8D_SLING
    </div>

    <div id="controls">
        <label for="visual-upload" class="btn">LOAD VISUAL CORE</label>
        <input type="file" id="visual-upload" accept="video/*,image/*">

        <label for="audio-upload" class="btn">LOAD AUDIO CORE</label>
        <input type="file" id="audio-upload" accept="audio/*">

        <label for="color-picker" class="color-container">
            SPECTRUM <div id="preview" class="color-preview" style="background:#00f3ff"></div>
        </label>
        <input type="color" id="color-picker" value="#00f3ff">

        <div id="mic-btn" class="btn">MIC SYNC</div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/postprocessing/ShaderPass.js';

        let audioCtx, analyser, dataArray;
        let bass = 0, avg = 0, treble = 0;
        let globalHue = 200;

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x010103, 0.055);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.z = 14;

        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('mainCanvas'), 
            antialias: false, alpha: false, powerPreference: "high-performance" 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 0.95;

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));

        // DARK TRANSPARENT VEIL (between visual background and particles)
        const veilShader = {
            uniforms: {
                tDiffuse: { value: null },
                veilOpacity: { value: 0.7 }, // 0.6â€“0.8 for subtle dark tint
                vignetteStrength: { value: 0.35 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform float veilOpacity;
                uniform float vignetteStrength;
                varying vec2 vUv;
                void main() {
                    vec4 color = texture2D(tDiffuse, vUv);
                    // Vignette (darkens edges)
                    float vignette = 1.0 - vignetteStrength * length(vUv - 0.5) * 2.0;
                    color.rgb *= vignette;
                    // Slight dark tint
                    color.rgb *= (1.0 - veilOpacity * 0.4);
                    gl_FragColor = color;
                }
            `
        };
        const veilPass = new ShaderPass(veilShader);
        composer.addPass(veilPass);

        // Bloom (now mostly affects particles after veil)
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.8, 0.5, 0.6);
        composer.addPass(bloom);

        // Controls + sling (same as before)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.09;
        controls.rotateSpeed = 0.8;
        controls.zoomSpeed = 1.3;
        controls.panSpeed = 0.9;
        controls.minDistance = 5;
        controls.maxDistance = 80;

        let slingVelocity = new THREE.Vector2();
        let isDragging = false;
        let lastPos = new THREE.Vector2();

        renderer.domElement.addEventListener('pointerdown', e => {
            isDragging = true;
            lastPos.set(e.clientX, e.clientY);
        });
        renderer.domElement.addEventListener('pointerup', () => isDragging = false);
        renderer.domElement.addEventListener('pointermove', e => {
            if (isDragging) {
                const delta = new THREE.Vector2(e.clientX - lastPos.x, e.clientY - lastPos.y);
                slingVelocity.add(delta.multiplyScalar(0.008));
                lastPos.set(e.clientX, e.clientY);
            }
        });

        // 8D Swarm + Cascade + Audio + Color Picker (unchanged from last working version)

        // ... (insert the full 8D code, spawnCascade, animate loop, hslToRgb, resize, etc.)

        animate();
    </script>
</body>
</html>
